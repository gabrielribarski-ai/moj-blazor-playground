@* filename: DeficitWithCorrection.razor *@
@using IzracunInvalidnostiBlazor.Models
@using IzracunInvalidnostiBlazor.Services
@inject LoaderService Loader
@inject UserSessionStorageService UserSessionStorage
@using CustomTypeExtensions
@using System.Globalization
@inject IConfiguration _config

<div class="deficit-block @CssClassForStran(Stran)">
    <h6 class="fw-bold">@NaslovZaStran(Stran)</h6>

    <div class="d-flex align-items-center gap-2">
        <DeficitSelector @key="@($"{DelTelesa.DelTelesaId}-{Stran}")"
                         Stran="Stran"
                         MozniZaStran="DelTelesa.MozniDeficitSeznam.Where(d => d.StranLDE == Stran)"
                         OnSelectionChanged="OnSelectionChanged"
                         Disabled="@(FazaOcenjevanja.In(FazaOcenjevanjaEnum.Zakljuceno, FazaOcenjevanjaEnum.OcenjevanjePotrjeno))" />

        @if (IzbranDeficit != null && (!FazaOcenjevanja.In(FazaOcenjevanjaEnum.Zakljuceno, FazaOcenjevanjaEnum.OcenjevanjePotrjeno)))
        {
            <button class="btn btn-link btn-sm p-0 ms-1 text-secondary"
                    title="Popravi"
                    @onclick="ToggleKorekcija">✎
            </button>
        }
    </div>

    @if (PrikaziKorekcijo && IzbranDeficit != null)
    {
        <div class="mt-2 ms-3 ps-2 border-start border-3 border-warning-subtle">
            <input type="text"
                   class="form-control form-control-sm mb-2"
                   placeholder="Ročni odstotek"
                   @bind-value="KorekcijaText"
                   @bind-value:event="oninput"
                   @onblur="NormalizeKorekcija"
                   disabled="@(FazaOcenjevanja.In(FazaOcenjevanjaEnum.Zakljuceno, FazaOcenjevanjaEnum.OcenjevanjePotrjeno))" />

            <textarea class="form-control form-control-sm"
                      rows="2"
                      placeholder="Komentar"
                      @bind-value="Komentar"
                      @bind-value:event="oninput"
                      readonly="@(FazaOcenjevanja.In(FazaOcenjevanjaEnum.Zakljuceno, FazaOcenjevanjaEnum.OcenjevanjePotrjeno))">
                </textarea>
        </div>
    }
</div>


@code {
    [Parameter] public DelTelesa DelTelesa { get; set; } = default!;
    [Parameter] public StranLDE Stran { get; set; }
    [Parameter] public EventCallback<(StranLDE stran, decimal? val)> OnSelectionChanged { get; set; }
    [Parameter] public FazaOcenjevanjaEnum FazaOcenjevanja { get; set; }

    private bool PrikaziKorekcijo;
    private string? korekcijaText;

    private void ToggleKorekcija()=> PrikaziKorekcijo = !PrikaziKorekcijo;
    private MozniDeficit? IzbranDeficit => DelTelesa.IzbranDeficit(Stran);

    protected override void OnParametersSet()
    {
        var korekcija = DelTelesa.GetKorekcija(Stran);
        korekcijaText = korekcija?.ToString(CultureInfo.CurrentCulture) ?? string.Empty;

        // če obstaja korekcija, naj bo polje odprto
        PrikaziKorekcijo = korekcija.HasValue;
    }


    private string? KorekcijaText
    {
        get => korekcijaText;
        set
        {
            korekcijaText = value;

            if (string.IsNullOrWhiteSpace(value))
            {
                DelTelesa.SetKorekcija(Stran, null);
                return;
            }

            if (TryParseDecimal(value, out var result))
            {
                DelTelesa.SetKorekcija(Stran, result);
            }
        }
    }

    private void NormalizeKorekcija(FocusEventArgs _)
    {
        if (string.IsNullOrWhiteSpace(korekcijaText))
        {
            DelTelesa.SetKorekcija(Stran, null);
            korekcijaText = string.Empty;
            return;
        }

        if (TryParseDecimal(korekcijaText, out var result))
        {
            DelTelesa.SetKorekcija(Stran, result);
            korekcijaText = result.ToString(CultureInfo.CurrentCulture);
        }
        else
        {
            // povrni zadnjo veljavno vrednost iz modela
            korekcijaText = DelTelesa.GetKorekcija(Stran)?.ToString(CultureInfo.CurrentCulture) ?? string.Empty;
        }

        StateHasChanged();
    }

    private static bool TryParseDecimal(string? input, out decimal result)
    {
        input = input?.Replace(',', '.');
        return decimal.TryParse(input, NumberStyles.Any, CultureInfo.InvariantCulture, out result);
    }

    private string? Komentar
    {
        get => DelTelesa.GetKomentar(Stran);
        set => DelTelesa.SetKomentar(Stran, value);
    }



    private string CssClassForStran(StranLDE stran) => stran switch
    {
        StranLDE.L => "stran-l",
        StranLDE.D => "stran-d",
        StranLDE.E => "stran-e",
        _ => ""
    };


    private string NaslovZaStran(StranLDE stran) => stran switch
    {
        StranLDE.L => "Leva stran (L)",
        StranLDE.D => "Desna stran (D)",
        StranLDE.E => "Enostransko (E)",
        _ => ""
    };
}
