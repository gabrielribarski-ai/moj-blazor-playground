@page "/oceni-invalidnost"
@using IzracunInvalidnostiBlazor.Extensions
@using IzracunInvalidnostiBlazor.Models
@using IzracunInvalidnostiBlazor.Services
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.Extensions.Logging
@inject NavigationManager NavigationManager
@inject OcenjevalniModelDBLoader ocenjevalniModelLoader
@inject ProtectedSessionStorage SessionStorage
@inject ILogger<Index> Logger
@rendermode InteractiveServer

<h6>Izberi del telesa za ocenjevanje</h6>

@if (ocenjevalniModel?.trenutniSegment == null)
{
    <p>Nalaganje podatkov...</p>
}
else
{
    <div class="row">
        <!-- Leva stran: glavni del -->
        <div class="col-md-6 small-font">
            <!-- Breadcrumb -->
            <div class="trenutna-pot-box mb-3">
                @foreach (var korak in ocenjevalniModel.BreadcrumbPath)
                {
                    var isLast = korak == ocenjevalniModel.BreadcrumbPath.Last();

                    <span class="crumb @(isLast ? "active" : "")"
                          @onclick="@(() => NavigirajNaSegment(korak))"
                          @key="korak.SegmentId">
                        @korak.Opis
                    </span>

                    @if (!isLast)
                    {
                        <span class="separator">🞂</span>
                    }
                }
            </div>


            <!-- Atributi -->
            @if (ocenjevalniModel?.AtributiZaPrikaz?.Count > 0)
            {
                <OcenjevalniAtribut Segment="ocenjevalniModel?.trenutniSegment"
                                    @key="ocenjevalniModel?.trenutniSegment?.SegmentId"
                                    OnOcenaPotrjena="OnSegmentPotrjen" />
            }

            <!-- Podsegmenti -->
            <div class="podsegment-list mb-4">
                @foreach (var seg in ocenjevalniModel?.SegmentiZaPrikaz)
                {
                    <div class="card podsegment-card mb-2"
                         @onclick="() => NavigirajNaSegment(seg)"
                         @key="seg.SegmentId">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-diagram-3 me-2 text-primary"></i>
                            <span>@seg.Opis</span>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Desna stran: že ocenjeni segmenti -->
        <div class="col-md-6 small-font">
            @if (ocenjevalniModel?.OcenjenSegmentSeznam?.Any() == true)
            {
                <div class="p-3 border rounded bg-light sticky-top" style="top: 1rem;">
                    <h5>Že ocenjeni segmenti</h5>
                    <ul class="list-group small">
                        @foreach (var seg in ocenjevalniModel.OcenjenSegmentSeznam)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><b>@seg.SegmentTreePath</b></span>
                                <span>@seg.SkupniOdstotekSegmenta %</span>
                                <button class="btn btn-sm btn-outline-primary"
                                        @onclick="() => VpogledVOcenjeniSegment(seg)">
                                    Vpogled
                                </button>
                            </li>
                        }
                    </ul>

                    <!-- Povzetek vseh segmentov -->
                    <div class="mt-3 text-end">
                        <strong>Skupaj:</strong> @ocenjevalniModel.SkupnaOcena %
                    </div>
                </div>
            }
        </div>
    </div>
}


@code {

    private bool _initialized = false;
    private Segment? TrenutniSegment;

    private OcenjevalniModel ocenjevalniModel;

    private List<Segment> OcenjeniSegmenti = new();
    private decimal SkupnaInvalidnost;

    private List<Segment> BreadcrumbPath = new();


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            ocenjevalniModel = await ocenjevalniModel.ReadFromSessionStorage(SessionStorage);
            StateHasChanged(); // Optional; OnAfterRenderAsync usually doesn’t need it after firstRender
        }
    }


    private async void OnSegmentPotrjen(Segment seg)
    {
        ocenjevalniModel.DodajMedOcenjeneSegmente(seg);
        ocenjevalniModel.TrenutniSegmentSet(ocenjevalniModel.GetRootSegment().SegmentId);

        await ocenjevalniModel.SaveSessionToStorage(SessionStorage);
    }



    private async Task NavigirajNaSegment(Segment segment)
    {
        await ocenjevalniModel.TrenutniSegmentSet(segment.SegmentId);

        await ocenjevalniModel.SaveSessionToStorage(SessionStorage);

        var atr = ocenjevalniModel?.AtributiZaPrikaz;
        if (atr?.Count > 0)
        {
            var json = System.Text.Json.JsonSerializer.Serialize(atr);
            Logger.LogInformation("Atributi za prikaz: {json}", json);
        }
    }



    private async Task VpogledVOcenjeniSegment(Segment seg)
    {
        ocenjevalniModel.VpogledVOcenjeniSegment(seg.SegmentId);
        seg.FazaOcenjevanja = FazaOcenjevanjaEnum.Vpogled;

        await ocenjevalniModel.SaveSessionToStorage(SessionStorage);
    }


}
