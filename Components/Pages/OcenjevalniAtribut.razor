@*** filename: OcenjevalniAtribut.razor ****@
@namespace IzracunInvalidnostiBlazor
@using System.Text.Json
@using CustomTypeExtensions
@using static IzracunInvalidnostiBlazor.OcenjevalniAtribut
@using IzracunInvalidnostiBlazor.Models
@using Microsoft.Extensions.Logging
@inject NavigationManager Nav
@inject ILogger<Index> Logger

<div class="segment-box listni">
    <h4>@Segment.Opis</h4>

    @foreach (var atribut in Segment.Atributi)
    {
        <div class="atribut-row">
            <label>@atribut.Opis (@atribut.Enota)</label>

            <table class="atribut-tabela">
                <thead>
                    <tr>
                        <th>E</th>
                        <th>L</th>
                        <th>S</th>
                        <th>D</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>

                            @if (atribut.TipMeritve == TipMeritveEnum.NUM)
                            {
                                <InputNumber @bind-Value="atribut.Ocena.VrednostE" class="form-control" />
                            }
                            else @if (atribut.TipMeritve == TipMeritveEnum.BOOL)
                            {
                                <InputCheckbox @bind-Value="atribut.Ocena.VrednostE_Bool" />
                            }
                        </td>
                        <td>
                            @if (atribut.TipMeritve == TipMeritveEnum.NUM)
                            {
                                <InputNumber @bind-Value="atribut.Ocena.VrednostL" class="form-control" />
                            }
                            else @if (atribut.TipMeritve == TipMeritveEnum.BOOL)
                            {
                                <InputCheckbox @bind-Value="atribut.Ocena.VrednostL_Bool" />
                            }
                        </td>
                        <td>
                            @atribut.StandardnaVrednost
                        </td>
                        <td>
                            @if (atribut.TipMeritve == TipMeritveEnum.NUM)
                            {
                                <InputNumber @bind-Value="atribut.Ocena.VrednostD" class="form-control" />
                            }
                            else @if (atribut.TipMeritve == TipMeritveEnum.BOOL)
                            {
                                <InputCheckbox @bind-Value="atribut.Ocena.VrednostD_Bool" />
                            }
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    }

    @if (!OcenaPotrjena)
    {
        <button class="btn btn-success mt-3" @onclick="PotrdiOceno">Potrdi oceno</button>
    }
    else
    {
        <div class="izbira-metode-box mt-3">
            <label>Izberi metodo ocenjevanja:</label>
            <select @bind="IzbranaMetoda" class="form-select">
                <option value="standard">Glede na standard</option>
                <option value="zdraviUd">Glede na zdravi ud</option>
            </select>

            <p class="mt-2">
                <strong>Deficiti:</strong><br />
                - Standard: @DeficitStandard?.ToString("0.0")%<br />
                - Zdravi ud: @DeficitRelativno?.ToString("0.0")%
            </p>
        </div>
    }
</div>

@code {

    [Parameter] public Segment Segment { get; set; } = default!;
    [Parameter] public List<Atribut> Atributi { get; set; } = new();

    private bool OcenaPotrjena = false;
    private string IzbranaMetoda = "standard";
    private decimal? DeficitStandard;
    private decimal? DeficitRelativno;

    public enum MoznaPrimerjava
    {
        L_primerjava_S, //LD
        D_primerjava_S, //LD
        L_primerjava_D, //LD
        D_primerjava_L,//LD
        E_primerjava_S //E
    }



    private MozniDeficit? MakeDeficit(MoznaPrimerjava tip, decimal dejanska, decimal referenca, StranLDE stranLDE)
    {
        if (Segment.SimetrijaDelaTelesa == SimetrijaDelaTelesa.E && stranLDE != StranLDE.E)
            return null;

        if (Segment.SimetrijaDelaTelesa == SimetrijaDelaTelesa.LD && stranLDE == StranLDE.E)
            return null;

        var deficit = CalcDeficit(dejanska, referenca);

        // zberi vse stopnje iz atributov trenutnega segmenta
        var vseStopnje = Segment.Atributi.SelectMany(a => a.Stopnje).ToList();

        return new MozniDeficit
        {
            moznePrimerjave = tip,
            Deficit = deficit,
            StranLDE = stranLDE,
            IzracunaniOdstotek = IzracunajInvalidnost(deficit, vseStopnje)
        };
    }



    public void IzracunajDeficit()
    {
        Segment.IzmerjeniDeficit = new();


        var simetrija = Segment.SimetrijaDelaTelesa;  // enum, ki vrne LD ali E
        // seštej vse vrednosti v enem koraku
        Segment.IzmerjeniDeficit.GibljivostSkupajL = Atributi.Sum(atr => atr.Ocena.VrednostL.AsDecimal());
        Segment.IzmerjeniDeficit.GibljivostSkupajD = Atributi.Sum(atr => atr.Ocena.VrednostD.AsDecimal());
        Segment.IzmerjeniDeficit.GibljivostSkupajE = Atributi.Sum(atr => atr.Ocena.VrednostE.AsDecimal());
        Segment.IzmerjeniDeficit.StandardSkupaj = Atributi.Sum(atr => atr.StandardnaVrednost.AsDecimal());

        List<MozniDeficit> deficiti = new List<MozniDeficit>();

        var kandidati = new[]
        {
            MakeDeficit(MoznaPrimerjava.E_primerjava_S, Segment.IzmerjeniDeficit.GibljivostSkupajE, Segment.IzmerjeniDeficit.StandardSkupaj, StranLDE.E),
            MakeDeficit(MoznaPrimerjava.D_primerjava_S, Segment.IzmerjeniDeficit.GibljivostSkupajD, Segment.IzmerjeniDeficit.StandardSkupaj, StranLDE.D),
            MakeDeficit(MoznaPrimerjava.L_primerjava_S, Segment.IzmerjeniDeficit.GibljivostSkupajL, Segment.IzmerjeniDeficit.StandardSkupaj, StranLDE.L),
            MakeDeficit(MoznaPrimerjava.L_primerjava_D, Segment.IzmerjeniDeficit.GibljivostSkupajL, Segment.IzmerjeniDeficit.GibljivostSkupajD, StranLDE.L),
            MakeDeficit(MoznaPrimerjava.D_primerjava_L, Segment.IzmerjeniDeficit.GibljivostSkupajD, Segment.IzmerjeniDeficit.GibljivostSkupajL, StranLDE.D)
        };

        //Logger.LogInformation("L_primerjava_D" + " : " + deficiti.Last().Deficit);
        deficiti.AddRange(kandidati.Where(d => d != null)!);

        foreach (var d in deficiti)
        {
            Logger.LogInformation(
                "Primerjava: {Primerjava}, Stran: {Stran}, Deficit: {Deficit}%",
                d.moznePrimerjave,
                d.StranLDE,
                d.Deficit?.ToString("0.00")
            );
        }
    }


    private void PotrdiOceno()
    {
        IzracunajDeficit();
        log_segment();

    }

    private void log_segment()
    {
        var json = JsonSerializer.Serialize(Segment, new JsonSerializerOptions { WriteIndented = true });
        Logger.LogInformation("OcenjevalniAtribut.razor->Segment {json}", json);
    }

    protected override async Task OnInitializedAsync()
    {
        foreach (Atribut atr in Atributi)
        {
            atr.Ocena = new();    
        }
    }

    private decimal CalcDeficit(decimal dejanska, decimal referenca)
    {
        if (referenca == 0) return 0;
        var razlika = Math.Abs(referenca - dejanska);
        return Math.Round((razlika / referenca) * 100, 2);
    }


    private decimal? IzracunajInvalidnost(decimal deficit, List<StopnjaDeficita> stopnje)
    {
        if (stopnje == null || stopnje.Count == 0)
            return null;

        var ordered = stopnje.OrderBy(s => s.ZapSt).ToList();

        for (int i = 0; i < ordered.Count; i++)
        {
            var s = ordered[i];

            // Fiksna stopnja
            if (s.OdstotekFR == OdstotekFR.F && deficit <= s.ObmocjeNum)
            {
                return s.StopnjaNum;
            }

            // Relativna stopnja
            if (s.OdstotekFR == OdstotekFR.R && i < ordered.Count - 1)
            {
                var next = ordered[i + 1];

                if (deficit > s.ObmocjeNum && deficit <= next.ObmocjeNum)
                {
                    // linearna interpolacija med StopnjaNum vrednostmi
                    var range = next.ObmocjeNum - s.ObmocjeNum;
                    var pos = (deficit - s.ObmocjeNum) / range;

                    var valueRange = next.StopnjaNum - s.StopnjaNum;
                    return s.StopnjaNum + pos * valueRange;
                }
            }
        }

        // če preseže vse stopnje, vrni max
        return ordered.Last().StopnjaNum;
    }



}